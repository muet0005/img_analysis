import os as os
import sys as sys
import csv as csv
import pwd
import numpy as np
import shutil as shutil
import nibabel as nb
from nibabel import nifti1 as nii
import nipype.interfaces.fsl as fsl
import nipype.interfaces.freesurfer as freesurfer
from nipype.interfaces.base import Undefined
import subprocess as sp
import socket as socket
import datetime as datetime
import argparse as argparse
import MySQLdb as mysqldb


__author__ = "Ryan Muetzel"
__license__ = "GPL"
__version__ = "0.2"


class qdec_clusters():
    def __init__(self, subjects_dir):
        """
        Required Arguments:
            subjects_dir = location of freesurfer data foldres.
        """
        self.subjects_dir = subjects_dir
        self.exclude = ('knicr', 'fsaverage', 'lh', 'rh')
        self.white_surf_meas = ('thickness', 'volume', 'wsurarea', 'wirmcurv', 'wirgcurv', 'wfoldind', 'wintcurv')
        self.pial_surf_meas = ('psurarea', 'pirmcurv', 'pirgcurv', 'pfoldind', 'pintcurv')
        self.lgi_surf_meas = ('lgi')
        self.surf_meas = {'white': self.white_surf_meas, 'pial': self.pial_surf_meas, 'pial_lgi': self.lgi_surf_meas}
        os.environ['SUBJECTS_DIR'] = subjects_dir
    
    def mapQdecLabel2Subjects(self, label, hemi, **kwargs):
        """
        Use mri_label2label to map label file from qdec to each subject.
        
        Required arguments:
            
            label = full path to the + name of the label file.
            
            hemi = hemisphere. lh or rh.
        
        Optional arguments:
            
            fsaverage = default is fsaverage. can specify custom template. Wherever the label was drawn on.
            
            regmethod. default is surface. volume is option as well.
             
            subjects. List type. If you want to run on a subset.  Otherwise, the default to to use the full subjects_dir listing.
            
            overwrite. boolean. if specified, label files existing in subject folder will be overwritten. otherwise skipped. default is False.
            
        """
        subjects = os.listdir(self.subjects_dir)
        measure = 'thickness'
        fsaverage = 'fsaverage'
        regmethod = 'surface'
        overwrite = False
        for i in kwargs.keys():
            if i == 'measure':
                measure = kwargs[i]
            elif i == 'fsaverage':
                fsaverage = kwargs[i]
            elif i == 'regmethod':
                regmethod = kwargs[i]
            elif i == 'overwrite':
                overwrite = True
            elif i == 'subjects':
                if type(kwargs[i]) is list:
                    subjects = kwargs[i]
        print 'Mapping labels for subjects:'
        for s in subjects:
            if s.startswith(self.exclude) or not os.path.exists(os.path.join(self.subjects_dir, s, 'label')):
                #get rid of the riff raff
                continue
            if os.path.exists(os.path.join(self.subjects_dir, s, 'label', os.path.basename(label) + '.label')):
                if not overwrite:
                    continue
            if not os.path.exists(os.path.join(self.subjects_dir, s, 'surf', hemi + '.white')):
                continue
            print s
            label2label = freesurfer.MRILabel2Label(srclabel=label + '.label', srcsubject=fsaverage, trgsubject=s, trglabel=os.path.basename(label), hemi=hemi, regmethod=regmethod)
            label2label.run()
    
    def computeQdecLabelStats(self, label, hemi, **kwargs):
        """
        Required Arguments:
            label. Just give the full path to the original qdec label. I'll figure out the rest.
            
            hemi = lh or rh
        
        Optional Arguments:
        Measure: This is the kind of stats to extract.
                    Avaialble options are:
                    self.white_surf_meas = ('thickness', 'volume', 'wsurarea', 'wirmcurv', 'wirgcurv', 'wfoldind', 'wintcurv')
                    self.pial_surf_meas = ('psurarea', 'pirmcurv', 'pirgcurv', 'pfoldind', 'pintcurv')
                    self.lgi_surf_meas = ('lgi')
                    If you choose a measure from self.white_surf_meas, it will use the *.white.stats output file to provide the stats.
                    The same goes for the pial and LGI stats.
                
        """
        subjects = os.listdir(self.subjects_dir)
        measure = 'thickness'
        overwrite = False
        for i in kwargs.keys():
            if i == 'measure':
                measure = kwargs[i]
            elif i == 'overwrite':
                overwrite = True
            elif i == 'subjects':
                if type(kwargs[i]) is list:
                    subjects = kwargs[i]
                    print 'Using custom subjects list: ', subjects
        print 'Generating stats for subjects: '
        for s in subjects:
            labelfile = os.path.join(self.subjects_dir, s, 'label', os.path.basename(label) + '.label')
            if not os.path.exists(labelfile) or s.startswith(self.exclude):
                continue
            stats = freesurfer.MRISAnatomicalStats(labelfile=labelfile, tabular=True, hemi=hemi, subject=s)
            if measure.startswith(self.white_surf_meas):
                stats.inputs.thicknessfile = hemi + '.thickness'
                surf = 'white'
            elif measure.startswith(self.pial_surf_meas):
                stats.inputs.surface = 'pial'
                surf = 'pial'
            elif measure.startswith(self.lgi_surf_meas):
                stats.inputs.thicknessfile = hemi + '.pial_lgi'
                surf = 'pial_lgi'
            oFile = os.path.join(self.subjects_dir, s, 'stats', os.path.basename(label) + '.' + surf + '.stats')
            if os.path.exists(oFile):
                if not overwrite:
                    continue
            print s
            stats.inputs.tablefile = oFile
            stats.run()
    
    def dumpQdecLabelStatsMysql(self, cursor, label, hemi, **kwargs):
        """
        Dump data from label file (stats output) into mysql db.
        
        Required:
            cursor -> Set up a mysql DB cursos. (see example below)
            label -> full path to label file, just as with other funcs in this class
            hemi -> lh or rh
        Optional:
            tblroot -> this will appar at hte front of your mysql table name (prepends the label name). default is qdec_label_
            id_col -> this is the name of the id column. default is idc.
            measure -> Available measures are:
                    self.white_surf_meas = ('thickness', 'volume', 'wsurarea', 'wirmcurv', 'wirgcurv', 'wfoldind', 'wintcurv')
                    self.pial_surf_meas = ('psurarea', 'pirmcurv', 'pirgcurv', 'pfoldind', 'pintcurv')
                    self.lgi_surf_meas = ('lgi')
                    see: http://freesurfer.net/fswiki/mris_anatomical_stats#Outputs
            subjects -> default is listing of subjects_dir. must be list type.
        
        Example:
        #set up your mysql connection
        >>>import MySQLdb as mysqldb
        
        #select a database to use:
        >>>mydb = 'freesurfer_v51_tests'
        
        #establish the con:
        >>>con = mysqldb.connect(db = mydb, read_default_file=os.path.join(os.getenv("HOME"), '.my.cnf'))
        
        #set the cursor:
        >>>cursor = con.cursor()
        
        """
        tblroot = 'qdec_label_'
        tbl = tblroot + os.path.basename(label).replace('.', '_').replace('-', '_') + '_' + measure
        id_col = 'idc'
        measure = 'thickness'
        subjects = os.listdir(self.subjects_dir)
        for i in kwargs.keys():
            if i == 'id_col':
                id_col = kwargs[i]
                print 'Resetting table ID column to: ', id_col
            elif i == 'measure':
                measure = kwargs[i]
                print 'Resetting measure to be: ', measure
            elif i == 'subjects':
                 if type(kwargs[i]) is list:
                     subjects = kwargs[i]
                     print 'Using custom subjects list: ', subjects  
            elif i == 'table':
                tbl = kwargs[i]
        try:
            cursor.execute("""create table %s (%s int)""" % (tbl, id_col))
        except:
            pass
        print 'Inserting stats into MysQL db:'
        for s in subjects:
            if s.startswith(self.exclude):
                continue
            #specify the file to read in
            if measure.startswith(self.white_surf_meas):
                stats_file = os.path.join(self.subjects_dir, s, 'stats', os.path.basename(label) + '.white.stats')
            elif measure.startswith(self.pial_surf_meas):
                stats_file = os.path.join(self.subjects_dir, s, 'stats', os.path.basename(label) + '.pial.stats')
            elif measure.startswith(self.lgi_surf_meas):
                stats_file = os.path.join(self.subjects_dir, s, 'stats', os.path.basename(label) + '.lgi.stats')
            if not os.path.exists(stats_file):
                continue
            print s
            #check the table to see if the subject exists
            cursor.execute("""select %s from %s where %s=\'%s\'""" % (id_col, tbl, id_col, s))
            pn_exist = cursor.fetchone()
            if not pn_exist:
                cursor.execute("""insert into %s (%s) values (\'%s\')""" % (tbl, id_col, s))
            statsFile = open(stats_file, 'r')
            stats_csv = csv.reader(statsFile, delimiter=' ')
            for row in stats_csv:
                if row[0] != '#':
                    for i in range(0, len(row)):
                        try:
                            row.index('')
                            row.remove('')
                        except:
                            continue
                        roi = row[0]
                        val_std = False
                        area_meas = ('wsurarea', 'psurarea')
                        irmcurv_meas = ('wirmcurv', 'pirmcurv')
                        irgcurv_meas = ('wirgcurv', 'pirgcurv')
                        foldind_meas = ('wfoldind', 'pfoldind')
                        intcurv = ('wintcurv', 'pintcurv')
                        col = roi.replace('.', '_') + '_' + measure   
                        if measure == 'thickness':
                            val = row[4]
                            val_std = row[5]
                            col = roi.replace('.', '_') + '_thickavg'
                            col_std = roi.replace('.', '_') + '_thickavg_std'
                        elif measure == 'lgi':
                            val = row[4]
                            val_std = row[5]
                            col = roi.replace('.', '_') + '_lgi'
                            col_std = roi.replace('.', '_') + '_lgi_std'
                        elif measure == 'volume':
                            val = row[3]
                        elif measure.startswith(area_meas):
                            val = row[2]
                        elif measure.startswith(irmcurv_meas):
                            val = row[6]
                        elif measure.startswith(irgcurv_meas):
                            val = row[7]
                        elif measure.startswith(foldind_meas):
                            val = row[8]
                        elif measure.startswith(intcurv):
                            val = row[9]
                        if val == '':
                            continue
                        val = float(val)
                        try:
                            cursor.execute("""alter table %s add column (%s float)""" % (tbl, col))
                        except:
                            pass
                        cursor.execute("""update %s set %s=%s where %s=\'%s\'""" % (tbl, col, val, id_col, s))
                        if val_std:
                            try:
                                cursor.execute("""alter table %s add column (%s float)""" % (tbl, col_std))
                            except:
                                pass
                            cursor.execute("""update %s set %s=%s where %s=\'%s\'""" % (tbl, col_std, val_std, id_col, s))
            statsFile.close()
    




                