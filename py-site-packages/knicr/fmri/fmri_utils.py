import os as os
import sys as sys
import csv as csv
from nibabel import nifti1 as nii
import numpy as np
import random

__author__ = "Ryan Muetzel"
__license__ = "GPL"
__version__ = "0.1"

class genFSLfsf():
	"""
	Class for generating  FSL MELODIC FSF files
	
	The initialization takes 7 arguments:
	
	fsfFile = the name of the resulting fsfFile
	
	featDIR = the folder where your fmri data are stored (with subjects as sub-folders)
	
	subjs = a python list of subject names that are in featDIR (can be 1 -> N subjects)
	
	outdir = the folder where you want the MELODIC output to be stored within the feadDIR/subj/ folder.  E.g., rest.ica
	
	fmrinii = the name of the raw fmri nifti file (to gather dimension information)
	
	tr = repetition time
	
	te = echo time
	
	cluster = bool, True/False, whether or not the script will be run on a cluster.
	
	
	"""
	def __init__(self, fsfFile, featDir, subjs, fmrinii_pfix, featdir_sfix, tr, te, mni_brain, cluster):
		self.fsfFile = fsfFile; self.featDir = featDir; self.subjs = subjs;self.fmrinii_pfix = fmrinii_pfix; self.featdir_sfix = featdir_sfix
		self.tr = tr; self.te = te
		self.cluster = cluster
		###feat-specific options###
		if not self.cluster:
			self.featwatcher = True
		else:
			self.featwatcher = False
		self.sscleanup = False
		self.ndelete = 0
		self.smooth = 5
		self.reghighres = False
		self.regstandard = '\"' + mni_brain + '\"'
		self.dim = False
		self.ndimensions = 16
	
	def genMelodicfsf(self, analysis, outputdir, nvols):
		fsf = []
		fsf.append('set fmri(version) 3.10' + '\n')
		fsf.append('set fmri(inmelodic) 1' + '\n')
		fsf.append('set fmri(level) 1' + '\n')
		fsf.append('set fmri(analysis) ' + str(analysis) + '\n')
		fsf.append('set fmri(relative_yn) 0' + '\n')
		fsf.append('set fmri(help_yn) 1' + '\n')
		fsf.append('set fmri(featwatcher_yn) ' + str(int(self.featwatcher)) + '\n')
		fsf.append('set fmri(sscleanup_yn) ' + str(int(self.sscleanup)) + '\n')
		fsf.append('set fmri(outputdir) \"' + outputdir + '\"' + '\n')
		fsf.append('set fmri(tr) ' + str(self.tr) + '\n')
		fsf.append('set fmri(npts) ' + str(nvols) + '\n')
		fsf.append('set fmri(ndelete) ' + str(self.ndelete) + '\n')
		fsf.append('set fmri(tagfirst) 1' + '\n')
		if type(self.subjs) is list:
			fsf.append('set fmri(multiple) ' + str(len(self.subjs)) + '\n')
		else:
			fsf.append('set fmri(multiple) 1' + '\n')
		fsf.append('set fmri(inputtype) 1' + '\n')
		prestats = {1: True, 2: False, 3: True, 4: False, 6: False, 7: True}
		fsf.append('set fmri(filtering_yn) ' + str(int(prestats[analysis])) + '\n')
		fsf.append('set fmri(brain_thresh) 10' + '\n')
		fsf.append('set fmri(critical_z) 5.3' + '\n')
		fsf.append('set fmri(noise) 0.66' + '\n')
		fsf.append('set fmri(noisear) 0.34' + '\n')
		fsf.append('set fmri(newdir_yn) 0' + '\n')
		fsf.append('set fmri(mc) 1' + str(int(prestats[analysis])) + '\n')
		fsf.append('set fmri(sh_yn) 0' + '\n')
		#TODO: need to work code in for this in the future; possibly consider using xnat dcm data base for params
		fsf.append('set fmri(regunwarp_yn) 0' + '\n')
		fsf.append('set fmri(dwell) 0.7' + '\n')
		fsf.append('set fmri(te) ' + str(self.te) + '\n')
		fsf.append('set fmri(signallossthresh) 10' + '\n')
		fsf.append('set fmri(unwarp_dir) y-' + '\n')
		fsf.append('set fmri(st) 0' + '\n')
		fsf.append('set fmri(st_file) \"\"' + '\n')
		fsf.append('set fmri(bet_yn) ' + str(int(prestats[analysis])) + '\n')
		fsf.append('set fmri(smooth) ' + str(self.smooth) + '\n')
		fsf.append('set fmri(norm_yn) 0' + '\n')
		fsf.append('set fmri(perfsub_yn) 0' + '\n')
		fsf.append('set fmri(temphp_yn) ' + str(int(prestats[analysis])) + '\n')
		fsf.append('set fmri(templp_yn) 0' + '\n')
		fsf.append('set fmri(melodic_yn) 0' + '\n')
		fsf.append('set fmri(stats_yn) 1' + '\n')
		fsf.append('set fmri(prewhiten_yn) 1' + '\n')
		fsf.append('set fmri(motionevs) 0' + '\n')
		fsf.append('set fmri(robust_yn) 0' + '\n')
		fsf.append('set fmri(mixed_yn) 2' + '\n')
		fsf.append('set fmri(evs_orig) 1' + '\n')
		fsf.append('set fmri(evs_real) 1' + '\n')
		fsf.append('set fmri(evs_vox) 0' + '\n')
		fsf.append('set fmri(ncon_orig) 1' + '\n')
		fsf.append('set fmri(ncon_real) 1' + '\n')
		fsf.append('set fmri(nftests_orig) 0' + '\n')
		fsf.append('set fmri(nftests_real) 0' + '\n')
		fsf.append('set fmri(constcol) 0' + '\n')
		poststats = {1: False, 2: False, 3: False, 4: True, 6: True, 7: True}
		fsf.append('set fmri(poststats_yn) ' + str(int(poststats[analysis])) + '\n')
		fsf.append('set fmri(threshmask) \"\"' + '\n')
		fsf.append('set fmri(thresh) 3' + '\n')
		fsf.append('set fmri(prob_thresh) 0.05' + '\n')
		fsf.append('set fmri(z_thresh) 2.3' + '\n')
		fsf.append('set fmri(zdisplay) 0' + '\n')
		fsf.append('set fmri(zmin) 2' + '\n')
		fsf.append('set fmri(zmax) 8' + '\n')
		fsf.append('set fmri(rendertype) 1' + '\n')
		fsf.append('set fmri(bgimage) 1' + '\n')
		fsf.append('set fmri(tsplot_yn) 1' + '\n')
		fsf.append('set fmri(reg_yn) 1' + '\n')
		fsf.append('set fmri(reginitial_highres_yn) 0' + '\n')
		fsf.append('set fmri(reginitial_highres_search) 90' + '\n')
		fsf.append('set fmri(reginitial_highres_dof) 3' + '\n')
		fsf.append('set fmri(reghighres_yn) ' + str(int(self.reghighres)) + '\n')
		fsf.append('set fmri(reghighres_search) 90' + '\n')
		fsf.append('set fmri(reghighres_dof) 6' + '\n')
		fsf.append('set fmri(regstandard_yn) 1' + '\n')
		fsf.append('set fmri(regstandard) ' + self.regstandard + '\n')
		fsf.append('set fmri(regstandard_search) 90' + '\n')
		fsf.append('set fmri(regstandard_dof) 12' + '\n')
		fsf.append('set fmri(regstandard_nonlinear_yn) 0' + '\n')
		fsf.append('set fmri(regstandard_nonlinear_warpres) 10' + '\n')
		fsf.append('set fmri(paradigm_hp) 100' + '\n')
		fsf.append('set fmri(ncopeinputs) 0' + '\n')
		if self.cluster:
			fsf.append('set feat_files(1) ' + '\"' + os.path.join(self.featDir, self.subjs, self.fmrinii_pfix + str(self.subjs) + '.nii.gz') + '\"\n')
		else:
			for i in range(1, len(self.subjs)+1):
				 fsf.append('set feat_files(' + str(i) + ') ' + '\"' + os.path.join(self.featDir, self.subjs[i-1], str(self.subjs[i-1]) + self.featdir_sfix) + '\"\n')
		fsf.append('set fmri(confoundevs) 0' + '\n')
		fsf.append('set fmri(regstandard_res) 4' + '\n')
		fsf.append('set fmri(varnorm) 1' + '\n')
		fsf.append('set fmri(dim_yn) ' + str(int(self.dim)) + '\n')
		if not self.dim:
			fsf.append('set fmri(dim) '+ str(self.ndimensions) + '\n')
		else:
			fsf.append('set fmri(dim) 1' + '\n')
		if type(self.subjs) is list:
			fsf.append('set fmri(icaopt) 2' + '\n')
		else:	
			fsf.append('set fmri(icaopt) 1' + '\n')
		fsf.append('set fmri(thresh_yn) 1' + '\n')
		fsf.append('set fmri(mmthresh) 0.5' + '\n')
		fsf.append('set fmri(ostats) 0' + '\n')
		fsf.append('set fmri(ts_model_mat) \"\"' + '\n')
		fsf.append('set fmri(ts_model_con) \"\"' + '\n')
		fsf.append('set fmri(subject_model_mat) \"\"' + '\n')
		fsf.append('set fmri(subject_model_con) \"\"' + '\n')
		fsf.append('set fmri(alternative_example_func) \"\"' + '\n')
		fsf.append('set fmri(alternative_mask) \"\"' + '\n')
		fsf.append('set fmri(init_initial_highres) \"\"' + '\n')
		fsf.append('set fmri(init_highres) \"\"' + '\n')
		fsf.append('set fmri(init_standard) \"\"' + '\n')
		fsf.append('set fmri(overwrite_yn) 0' + '\n')
		f = open(self.fsfFile, 'w')
		f.writelines(fsf)
		f.close()
	
	def genFeatfsf(self, analysis, outputdir, nvols):
		fsf = []
		fsf.append('set fmri(version) 5.98' + '\n')
		fsf.append('set fmri(inmelodic) 0' + '\n')
		fsf.append('set fmri(level) 1' + '\n')
		fsf.append('set fmri(analysis) ' + str(analysis) + '\n')
		fsf.append('set fmri(relative_yn) 0' + '\n')
		fsf.append('set fmri(help_yn) 1' + '\n')
		fsf.append('set fmri(featwatcher_yn) ' + str(int(self.featwatcher)) + '\n')
		fsf.append('set fmri(sscleanup_yn) ' + str(int(self.sscleanup)) + '\n')
		fsf.append('set fmri(outputdir) \"' + outputdir + '\"' + '\n')
		fsf.append('set fmri(tr) ' + str(self.tr) + '\n')
		fsf.append('set fmri(npts) ' + str(nvols) + '\n')
		fsf.append('set fmri(ndelete) ' + str(self.ndelete) + '\n')
		fsf.append('set fmri(tagfirst) 1' + '\n')
		if type(self.subjs) is list:
			fsf.append('set fmri(multiple) ' + str(len(self.subjs)) + '\n')
		else:
			fsf.append('set fmri(multiple) 1' + '\n')
		fsf.append('set fmri(inputtype) 1' + '\n')
		prestats = {1: True, 2: False, 3: True, 4: False, 6: False, 7: True}
		fsf.append('set fmri(filtering_yn) 1' + '\n')
		fsf.append('set fmri(brain_thresh) 10' + '\n')
		fsf.append('set fmri(critical_z) 5.3' + '\n')
		fsf.append('set fmri(noise) 0.66' + '\n')
		fsf.append('set fmri(noisear) 0.34' + '\n')
		fsf.append('set fmri(newdir_yn) 0' + '\n')
		fsf.append('set fmri(mc) 1' + '\n')
		fsf.append('set fmri(sh_yn) 0' + '\n')
		#TODO: need to work code in for this in the future; possibly consider using xnat dcm data base for params
		fsf.append('set fmri(regunwarp_yn) 0' + '\n')
		fsf.append('set fmri(dwell) 0.7' + '\n')
		fsf.append('set fmri(te) ' + str(self.te) + '\n')
		fsf.append('set fmri(signallossthresh) 10' + '\n')
		fsf.append('set fmri(unwarp_dir) y-' + '\n')
		fsf.append('set fmri(st) 0' + '\n')
		fsf.append('set fmri(st_file) \"\"' + '\n')
		fsf.append('set fmri(bet_yn) 1' + '\n')
		fsf.append('set fmri(smooth) ' + str(self.smooth) + '\n')
		fsf.append('set fmri(norm_yn) 0' + '\n')
		fsf.append('set fmri(perfsub_yn) 0' + '\n')
		fsf.append('set fmri(temphp_yn) 1' + '\n')
		fsf.append('set fmri(templp_yn) 0' + '\n')
		fsf.append('set fmri(melodic_yn) 0' + '\n')
		fsf.append('set fmri(stats_yn) 1' + '\n')
		fsf.append('set fmri(prewhiten_yn) 1' + '\n')
		fsf.append('set fmri(motionevs) 0' + '\n')
		fsf.append('set fmri(robust_yn) 0' + '\n')
		fsf.append('set fmri(mixed_yn) 2' + '\n')
		fsf.append('set fmri(evs_orig) 1' + '\n')
		fsf.append('set fmri(evs_real) 2' + '\n')
		fsf.append('set fmri(evs_vox) 0' + '\n')
		fsf.append('set fmri(ncon_orig) 1' + '\n')
		fsf.append('set fmri(ncon_real) 1' + '\n')
		fsf.append('set fmri(nftests_orig) 0' + '\n')
		fsf.append('set fmri(nftests_real) 0' + '\n')
		fsf.append('set fmri(constcol) 0' + '\n')
		poststats = {1: False, 2: False, 3: False, 4: True, 6: True, 7: True}
		fsf.append('set fmri(poststats_yn) ' + str(int(poststats[analysis])) + '\n')
		fsf.append('set fmri(threshmask) \"\"' + '\n')
		fsf.append('set fmri(thresh) 3' + '\n')
		fsf.append('set fmri(prob_thresh) 0.05' + '\n')
		fsf.append('set fmri(z_thresh) 2.3' + '\n')
		fsf.append('set fmri(zdisplay) 0' + '\n')
		fsf.append('set fmri(zmin) 2' + '\n')
		fsf.append('set fmri(zmax) 8' + '\n')
		fsf.append('set fmri(rendertype) 1' + '\n')
		fsf.append('set fmri(bgimage) 1' + '\n')
		fsf.append('set fmri(tsplot_yn) 1' + '\n')
		fsf.append('set fmri(reg_yn) 1' + '\n')
		fsf.append('set fmri(reginitial_highres_yn) 0' + '\n')
		fsf.append('set fmri(reginitial_highres_search) 90' + '\n')
		fsf.append('set fmri(reginitial_highres_dof) 3' + '\n')
		fsf.append('set fmri(reghighres_yn) ' + str(int(self.reghighres)) + '\n')
		fsf.append('set fmri(reghighres_search) 90' + '\n')
		fsf.append('set fmri(reghighres_dof) 6' + '\n')
		fsf.append('set fmri(regstandard_yn) 1' + '\n')
		fsf.append('set fmri(regstandard) ' + self.regstandard + '\n')
		fsf.append('set fmri(regstandard_search) 90' + '\n')
		fsf.append('set fmri(regstandard_dof) 12' + '\n')
		fsf.append('set fmri(regstandard_nonlinear_yn) 0' + '\n')
		fsf.append('set fmri(regstandard_nonlinear_warpres) 10' + '\n')
		fsf.append('set fmri(paradigm_hp) 100' + '\n')
		fsf.append('set fmri(ncopeinputs) 0' + '\n')
		if self.cluster:
			fsf.append('set feat_files(1) ' + '\"' + os.path.join(self.featDir, self.subjs, self.fmrinii_pfix + str(self.subjs) + '.nii.gz') + '\"\n')
		else:
			for i in range(1, len(self.subjs)+1):
				 fsf.append('set feat_files(' + str(i) + ') ' + '\"' + os.path.join(self.featDir, self.subjs[i-1], str(self.subjs[i-1]) + self.featdir_sfix) + '\"\n')
		fsf.append('set fmri(confoundevs) 0' + '\n')
		fsf.append('set fmri(evtitle1) \"\"' + '\n')
		fsf.append('set fmri(shape1) 0' + '\n')
		fsf.append('set fmri(convolve1) 2' + '\n')
		fsf.append('set fmri(convolve_phase1) 0' + '\n')
		fsf.append('set fmri(tempfilt_yn1) 1' + '\n')
		fsf.append('set fmri(deriv_yn1) 1' + '\n')
		fsf.append('set fmri(skip1) 0' + '\n')
		fsf.append('set fmri(off1) 30' + '\n')
		fsf.append('set fmri(on1) 30' + '\n')
		fsf.append('set fmri(phase1) 0' + '\n')
		fsf.append('set fmri(stop1) -1' + '\n')
		fsf.append('set fmri(gammasigma1) 3' + '\n')
		fsf.append('set fmri(gammadelay1) 6' + '\n')
		fsf.append('set fmri(ortho1.0) 0' + '\n')
		fsf.append('set fmri(ortho1.1) 0' + '\n')
		fsf.append('set fmri(con_mode_old) orig' + '\n')
		fsf.append('set fmri(con_mode) orig' + '\n')
		fsf.append('set fmri(conpic_real.1) 1' + '\n')
		fsf.append('set fmri(conname_real.1) \"\"' + '\n')
		fsf.append('set fmri(con_real1.1) 1' + '\n')
		fsf.append('set fmri(con_real1.2) 0' + '\n')
		fsf.append('set fmri(conpic_orig.1) 1' + '\n')
		fsf.append('set fmri(conname_orig.1) \"\"' + '\n')
		fsf.append('set fmri(con_orig1.1) 1' + '\n')
		fsf.append('set fmri(conmask_zerothresh_yn) 0' + '\n')
		fsf.append('set fmri(conmask1_1) 0' + '\n')
		fsf.append('set fmri(thresh_yn) 1' + '\n')
		fsf.append('set fmri(mmthresh) 0.5' + '\n')
		fsf.append('set fmri(ostats) 0' + '\n')
		fsf.append('set fmri(ts_model_mat) \"\"' + '\n')
		fsf.append('set fmri(ts_model_con) \"\"' + '\n')
		fsf.append('set fmri(subject_model_mat) \"\"' + '\n')
		fsf.append('set fmri(subject_model_con) \"\"' + '\n')
		fsf.append('set fmri(alternative_example_func) \"\"' + '\n')
		fsf.append('set fmri(alternative_mask) \"\"' + '\n')
		fsf.append('set fmri(init_initial_highres) \"\"' + '\n')
		fsf.append('set fmri(init_highres) \"\"' + '\n')
		fsf.append('set fmri(init_standard) \"\"' + '\n')
		fsf.append('set fmri(overwrite_yn) 0' + '\n')
		f = open(self.fsfFile, 'w')
		f.writelines(fsf)
		f.close()
	
	def genPreStatsfsf(self):
		if type(self.subjs) is list:
			subj = self.subjs[0]
		else:
			subj = self.subjs
		subjDir = os.path.join(self.featDir, subj)
		niiFile = os.path.join(subjDir, self.fmrinii_pfix + str(subj) + '.nii.gz')
		outputdir = os.path.join(self.featDir, subj, str(subj) + self.featdir_sfix)
		if os.path.exists(niiFile):
			n = nii.load(niiFile)
			dims = n.get_shape()
			x = dims[0]; y = dims[1]; z = dims[2]; t = dims[3]
			analysis = 7
			self.genFeatfsf(analysis, outputdir, t)
		else:
			print 'NII FILE DOES NOT EXIST!', niiFile
			
	
	def genGroupMelodicfsf(self, melodic_output):
		subjDir = os.path.join(self.featDir, self.subjs[0])
		niiFile = os.path.join(subjDir, self.fmrinii_pfix + str(self.subjs[0]) + '.nii.gz')
		if os.path.exists(niiFile):
			n = nii.load(niiFile)
			dims = n.get_shape()
			x = dims[0]; y = dims[1]; z = dims[2]; t = dims[3]
			analysis = 2
			self.genMelodicfsf(analysis, melodic_output, t)
		else:
			return False
	



class gen_bootstrap_samples():
	"""
	Class to generate random list of subjects for melodic analyses
	
	Functions include:
	
	read_subj_list to read a list of Rnumbers/IDCs
	
	gen_samples to generate the list of random id numbers
	
	gen_melodic_lisa to generate a text file to be passed to FSLs melodic command line.
	"""
	def __init__(self):
		self.subjs = []
		self.samples = []
	
	def read_subj_list(self, subj_list):
		"""
		Read in a subject list.  This assumes "subj_list" is a text file with each subject id number on a new line.
		
		The data read in here is passed to gen_samples and gen_melodic_list.
		"""
		if len(self.subjs) > 0:
			print 'WARNING:		It appears read_subj_list has already been run.  To prevent problems, subject list has been reset...this is only a warning.'
			self.subjs = []
		sl = open(subj_list, 'r')
		for line in sl:
			if not str(line).replace('\n', '') == '':
				self.subjs.append(str(line).replace('\n', ''))
	
	def gen_samples(self, nSamples, N):
		"""
		Script to generate a list of of random subject ids.
		
		Within this list, you have nSamples lists.  Each nSamples list holds N subjects.
		
		nSamples = the number of lists of random subjects you want
		N = the number of subjects per list.
		
		"""
		nSubjs = len(self.subjs)
		if len(self.samples) > 0:
			print 'WARNING:		It appears gen_samples has already been run.  To prevent problems, samples list has been reset....this is only a warning.'
			self.samples = []
		for n in range(0, nSamples):
			sample_subjs = []
			while len(sample_subjs) < N:
				rand_int = random.randint(0, nSubjs-1)
				try:
					sample_subjs.index(self.subjs[rand_int])
				except:
					sample_subjs.append(self.subjs[rand_int])
			self.samples.append(sample_subjs)
	
	def gen_melodic_lisa(self, fmri_dir, feat_sfix, melodic_sample_dir, samples_sfix):
		"""
		Will generate text files to feed the melodic command line utility with a list of filtered func data from feat.
		
		Args:
		
		fmri_dir = where the feat processed fmri datasets are located.  This assumes the following directory hierarchy:
			feat_dir/subject/subject.feat
		
		feat_sfix = The naming convention for the feat folder within the subject folder.  This assumes the folder starts with the subject id.
			feat_sfix = 1_Apr2013.feat, where "1" is the subject id number.
		
		melodic_sample_dir = where the subject lists for melodic will be saved out.
		
		samples_sfix = the suffix to be used for the above mentioned subject lists.
			
		"""
		nSamples = len(self.samples)
		for s in range(0, nSamples):
			odir = os.path.join(melodic_sample_dir, 'sample.' + str(s) + '.' + samples_sfix)
			if not os.path.exists(odir):
				os.makedirs(odir)
			oFile = os.path.join(melodic_sample_dir, 'sample.' + str(s) + '.' + samples_sfix, 'sample.' + str(s))
			if not os.path.exists(oFile):
				f = open(oFile, 'w')
				for l in self.samples[s]:
					f.write(os.path.join(fmri_dir, str(l),  str(l) + feat_sfix, 'filtered_func_data_2_standard.nii.gz' + '\n'))
				f.close()
			else:
				print 'WARNING:		Output file: ', oFile, '  Already exists...will not overwrite! Please remove existing files, change your output suffix, or change the output folder.'
	

